// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  OFFICER
  AUDITOR
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  FLAGGED
}

model User {
  id             String   @id @default(cuid())
  nationalId     String   @unique @map("national_id")
  email          String   @unique
  password       String
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  role           Role     @default(OFFICER)
  isActive       Boolean  @default(true) @map("is_active")
  resetToken     String?  @map("reset_token")
  resetExpires   DateTime? @map("reset_expires")
  lastLogin      DateTime? @map("last_login")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  createdMembers      Member[]      @relation("CreatedByOfficer")
  processedTransactions Transaction[] @relation("ProcessedByOfficer")
  approvedLoans       Loan[]        @relation("ApprovedByOfficer")
  resolvedAlerts      FraudAlert[]  @relation("ResolvedByUser")
  auditLogs           AuditLog[]    @relation("AuditLogUser")
  notifications       Notification[] @relation("UserNotifications")
  investigations      CaseInvestigation[] @relation("InvestigatedByUser")
  documents           Document[]    @relation("UploadedByUser")
  auditReviews        AuditReview[] @relation("ReviewedByAuditor")
  complianceReports   ComplianceReport[] @relation("GeneratedByAuditor")
  // Fraud Detection Engine relations
  createdFraudRules     FraudRule[]         @relation("FraudRuleCreator")
  reviewedViolations    RuleViolation[]     @relation("ViolationReviewer")
  reviewedWithdrawals   WithdrawalRequest[] @relation("WithdrawalReviewer")
  approvedDecisions     FraudDecision[]     @relation("DecisionApprover")
  updatedThresholds     WithdrawalThreshold[] @relation("ThresholdUpdater")

  @@map("users")
}

model Member {
  id          String       @id @default(cuid())
  memberId    String       @unique @map("member_id")
  fullName    String       @map("full_name")
  email       String       @unique
  phoneNumber String       @map("phone_number")
  status      MemberStatus @default(ACTIVE)
  balance     Float        @default(0)
  createdById String       @map("created_by_id")
  createdBy   User         @relation("CreatedByOfficer", fields: [createdById], references: [id])
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  transactions      Transaction[]
  loans              Loan[]
  fraudAlerts        FraudAlert[]
  ruleViolations     RuleViolation[]
  withdrawalRequests WithdrawalRequest[]
  riskScore          MemberRiskScore?
  fraudDecisions     FraudDecision[]

  @@map("members")
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  LOAN_DISBURSEMENT
  LOAN_REPAYMENT
}

enum TransactionStatus {
  COMPLETED
  PENDING
  FAILED
  FLAGGED
}

model Transaction {
  id          String            @id @default(cuid())
  txRef       String            @unique @map("tx_ref")
  type        TransactionType
  amount      Float
  balanceBefore Float           @map("balance_before")
  balanceAfter  Float           @map("balance_after")
  description String?
  status      TransactionStatus @default(COMPLETED)
  memberId    String            @map("member_id")
  member      Member            @relation(fields: [memberId], references: [id])
  processedById String          @map("processed_by_id")
  processedBy   User            @relation("ProcessedByOfficer", fields: [processedById], references: [id])
  loanId      String?           @map("loan_id")
  loan        Loan?             @relation(fields: [loanId], references: [id])
  fraudAlerts    FraudAlert[]
  ruleViolations RuleViolation[]
  fraudDecisions FraudDecision[]
  createdAt      DateTime          @default(now()) @map("created_at")

  @@map("transactions")
}

enum LoanStatus {
  PENDING
  APPROVED
  ACTIVE
  COMPLETED
  DEFAULTED
  REJECTED
}

model Loan {
  id             String     @id @default(cuid())
  loanRef        String     @unique @map("loan_ref")
  amount         Float
  interestRate   Float      @map("interest_rate")
  termMonths     Int        @map("term_months")
  monthlyPayment Float      @map("monthly_payment")
  totalRepaid    Float      @default(0) @map("total_repaid")
  outstandingBalance Float  @map("outstanding_balance")
  status         LoanStatus @default(PENDING)
  purpose        String?
  memberId       String     @map("member_id")
  member         Member     @relation(fields: [memberId], references: [id])
  approvedById   String?    @map("approved_by_id")
  approvedBy     User?      @relation("ApprovedByOfficer", fields: [approvedById], references: [id])
  transactions   Transaction[]
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  @@map("loans")
}

enum FraudSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model FraudAlert {
  id            String        @id @default(cuid())
  type          String
  severity      FraudSeverity
  description   String
  resolved      Boolean       @default(false)
  resolvedById  String?       @map("resolved_by_id")
  resolvedBy    User?         @relation("ResolvedByUser", fields: [resolvedById], references: [id])
  resolvedAt    DateTime?     @map("resolved_at")
  memberId      String        @map("member_id")
  member        Member        @relation(fields: [memberId], references: [id])
  transactionId String?       @map("transaction_id")
  transaction   Transaction?  @relation(fields: [transactionId], references: [id])
  case          CaseInvestigation? @relation("AlertCase")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@map("fraud_alerts")
}

// ─── Audit Log ──────────────────────────────────────────────────────────
model AuditLog {
  id          String   @id @default(cuid())
  action      String
  entity      String
  entityId    String?  @map("entity_id")
  details     String?
  ipAddress   String?  @map("ip_address")
  userId      String   @map("user_id")
  user        User     @relation("AuditLogUser", fields: [userId], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}

// ─── Notifications ──────────────────────────────────────────────────────
model Notification {
  id        String   @id @default(cuid())
  title     String
  message   String
  type      String   @default("info")  // info, warning, error, success
  read      Boolean  @default(false)
  userId    String   @map("user_id")
  user      User     @relation("UserNotifications", fields: [userId], references: [id])
  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

// ─── Risk Policies ──────────────────────────────────────────────────────
model RiskPolicy {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  enabled     Boolean  @default(true)
  threshold   Float?
  severity    FraudSeverity @default(MEDIUM)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("risk_policies")
}

// ─── System Config ──────────────────────────────────────────────────────
model SystemConfig {
  id    String @id @default(cuid())
  key   String @unique
  value String
  label String
  group String @default("general")

  @@map("system_config")
}

// ─── Case Investigation ─────────────────────────────────────────────────
enum CaseStatus {
  OPEN
  IN_PROGRESS
  ESCALATED
  CLOSED
  DISMISSED
}

model CaseInvestigation {
  id            String      @id @default(cuid())
  caseRef       String      @unique @map("case_ref")
  title         String
  description   String
  status        CaseStatus  @default(OPEN)
  priority      FraudSeverity @default(MEDIUM)
  findings      String?
  resolution    String?
  alertId       String?     @unique @map("alert_id")
  alert         FraudAlert? @relation("AlertCase", fields: [alertId], references: [id])
  assignedToId  String      @map("assigned_to_id")
  assignedTo    User        @relation("InvestigatedByUser", fields: [assignedToId], references: [id])
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  @@map("case_investigations")
}

// ─── Documents ──────────────────────────────────────────────────────────
model Document {
  id          String   @id @default(cuid())
  name        String
  fileName    String   @map("file_name")
  fileSize    Int      @map("file_size")
  mimeType    String   @map("mime_type")
  category    String   @default("general")
  description String?
  data        Bytes
  uploadedById String  @map("uploaded_by_id")
  uploadedBy  User     @relation("UploadedByUser", fields: [uploadedById], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("documents")
}

// ─── Audit Review ───────────────────────────────────────────────────────
enum ReviewStatus {
  DRAFT
  IN_PROGRESS
  UNDER_REVIEW
  COMPLETED
  ARCHIVED
}

enum ReviewCategory {
  FINANCIAL
  COMPLIANCE
  SECURITY
  RISK
  OPERATIONAL
}

model AuditReview {
  id              String         @id @default(cuid())
  reviewRef       String         @unique @map("review_ref")
  title           String
  description     String
  category        ReviewCategory @default(FINANCIAL)
  status          ReviewStatus   @default(DRAFT)
  riskLevel       FraudSeverity  @default(MEDIUM)
  findings        String?
  recommendations String?
  reviewerId      String         @map("reviewer_id")
  reviewer        User           @relation("ReviewedByAuditor", fields: [reviewerId], references: [id])
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@map("audit_reviews")
}

// ─── Compliance Report ──────────────────────────────────────────────────
enum ReportStatus {
  DRAFT
  PUBLISHED
}

model ComplianceReport {
  id            String       @id @default(cuid())
  reportRef     String       @unique @map("report_ref")
  title         String
  category      String
  period        String
  summary       String
  content       String
  status        ReportStatus @default(DRAFT)
  generatedById String       @map("generated_by_id")
  generatedBy   User         @relation("GeneratedByAuditor", fields: [generatedById], references: [id])
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  @@map("compliance_reports")
}

// ═══════════════════════════════════════════════════════════════════════════
// FRAUD DETECTION ENGINE
// ═══════════════════════════════════════════════════════════════════════════

// ─── Fraud Rules (Rule Engine) ──────────────────────────────────────────
enum RuleType {
  FREQUENCY
  AMOUNT
  NO_DEPOSIT
  CUSTOM
}

model FraudRule {
  id              String        @id @default(cuid())
  name            String        @unique
  description     String
  ruleType        RuleType      @map("rule_type")
  enabled         Boolean       @default(true)
  // For FREQUENCY rules: max allowed count within windowHours
  maxCount        Int?          @map("max_count")
  windowHours     Int?          @map("window_hours")
  // For AMOUNT rules: min/max withdrawal thresholds
  minAmount       Float?        @map("min_amount")
  maxAmount       Float?        @map("max_amount")
  // Severity when triggered
  severity        FraudSeverity @default(MEDIUM)
  // Points to add to risk score when this rule fires
  riskPoints      Int           @default(10) @map("risk_points")
  createdById     String        @map("created_by_id")
  createdBy       User          @relation("FraudRuleCreator", fields: [createdById], references: [id])
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  ruleViolations  RuleViolation[]

  @@map("fraud_rules")
}

// ─── Rule Violations (when a rule fires) ────────────────────────────────
model RuleViolation {
  id              String        @id @default(cuid())
  ruleId          String        @map("rule_id")
  rule            FraudRule     @relation(fields: [ruleId], references: [id])
  memberId        String        @map("member_id")
  member          Member        @relation(fields: [memberId], references: [id])
  transactionId   String?       @map("transaction_id")
  transaction     Transaction?  @relation(fields: [transactionId], references: [id])
  details         String
  riskPoints      Int           @map("risk_points")
  reviewed        Boolean       @default(false)
  reviewedById    String?       @map("reviewed_by_id")
  reviewedBy      User?         @relation("ViolationReviewer", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?     @map("reviewed_at")
  reviewNotes     String?       @map("review_notes")
  createdAt       DateTime      @default(now()) @map("created_at")

  @@map("rule_violations")
}

// ─── Large Withdrawal Requests ──────────────────────────────────────────
enum WithdrawalRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model WithdrawalRequest {
  id              String                   @id @default(cuid())
  requestRef      String                   @unique @map("request_ref")
  memberId        String                   @map("member_id")
  member          Member                   @relation(fields: [memberId], references: [id])
  amount          Float
  reason          String
  supportingDoc   String?                  @map("supporting_doc")
  status          WithdrawalRequestStatus  @default(PENDING)
  reviewedById    String?                  @map("reviewed_by_id")
  reviewedBy      User?                    @relation("WithdrawalReviewer", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?                @map("reviewed_at")
  reviewNotes     String?                  @map("review_notes")
  createdAt       DateTime                 @default(now()) @map("created_at")
  updatedAt       DateTime                 @updatedAt @map("updated_at")

  @@map("withdrawal_requests")
}

// ─── Member Risk Score ──────────────────────────────────────────────────
enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model MemberRiskScore {
  id                  String    @id @default(cuid())
  memberId            String    @unique @map("member_id")
  member              Member    @relation(fields: [memberId], references: [id])
  totalPoints         Int       @default(0) @map("total_points")
  riskLevel           RiskLevel @default(LOW) @map("risk_level")
  frequencyPoints     Int       @default(0) @map("frequency_points")
  amountPoints        Int       @default(0) @map("amount_points")
  behaviorPoints      Int       @default(0) @map("behavior_points")
  noDepositPoints     Int       @default(0) @map("no_deposit_points")
  avgTransactionAmount Float?   @map("avg_transaction_amount")
  transactionFrequency Float?   @map("transaction_frequency")
  lastCalculatedAt    DateTime  @default(now()) @map("last_calculated_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("member_risk_scores")
}

// ─── Fraud Decision Log ─────────────────────────────────────────────────
enum DecisionAction {
  ALERT_TRIGGERED
  SECOND_APPROVAL_REQUIRED
  TRANSACTION_BLOCKED
  ACCOUNT_FLAGGED
  MANUAL_REVIEW
  AUTO_APPROVED
}

model FraudDecision {
  id              String          @id @default(cuid())
  memberId        String          @map("member_id")
  member          Member          @relation(fields: [memberId], references: [id])
  transactionId   String?         @map("transaction_id")
  transaction     Transaction?    @relation(fields: [transactionId], references: [id])
  riskScore       Int             @map("risk_score")
  riskLevel       RiskLevel       @map("risk_level")
  action          DecisionAction
  reason          String
  requiresApproval Boolean        @default(false) @map("requires_approval")
  approved        Boolean?
  approvedById    String?         @map("approved_by_id")
  approvedBy      User?           @relation("DecisionApprover", fields: [approvedById], references: [id])
  approvedAt      DateTime?       @map("approved_at")
  createdAt       DateTime        @default(now()) @map("created_at")

  @@map("fraud_decisions")
}

// ─── Withdrawal Thresholds (configurable by officers) ───────────────────
model WithdrawalThreshold {
  id                    String   @id @default(cuid())
  largeWithdrawalAmount Float    @map("large_withdrawal_amount")
  dailyWithdrawalLimit  Float    @map("daily_withdrawal_limit")
  maxWithdrawalsPerDay  Int      @default(5) @map("max_withdrawals_per_day")
  requireApprovalAbove  Float    @map("require_approval_above")
  updatedById           String   @map("updated_by_id")
  updatedBy             User     @relation("ThresholdUpdater", fields: [updatedById], references: [id])
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("withdrawal_thresholds")
}
